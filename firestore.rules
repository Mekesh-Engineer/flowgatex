rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Fetch role from the database
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().role;
    }

    function getUserOrgId() {
      return getUserData().organizationId;
    }

    function getUserAccountStatus() {
      return getUserData().accountStatus;
    }

    function isActive() {
      return isAuthenticated() && getUserAccountStatus() == 'active';
    }

    function isOrganizer() {
      return isAuthenticated() && getUserRole() == 'organizer';
    }

    function isOrgAdmin() {
      return isAuthenticated() && getUserRole() == 'org_admin';
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'superadmin';
    }

    function isAdminOrAbove() {
      return isAdmin() || isSuperAdmin();
    }

    function isOrgAdminOrAbove() {
      return isOrgAdmin() || isAdminOrAbove();
    }

    function isOrganizerOrAbove() {
      return isOrganizer() || isOrgAdminOrAbove();
    }

    function isValidRole(role) {
      return role in ['user', 'organizer', 'org_admin', 'admin', 'superadmin'];
    }

    // Feature flag check — reads from SettingInfo/platform
    function getFeatureFlag(flagName) {
      return get(path('/databases/' + database + '/documents/SettingInfo/platform')).data.featureFlags[flagName];
    }

    // Organization settings check
    function getOrgSettings(orgId) {
      return get(path('/databases/' + database + '/documents/SettingInfo/organization_' + orgId)).data;
    }

    // =========================================================================
    // COLLECTION RULES
    // =========================================================================
    
    // ======================== USERS COLLECTION ==============================
    match /users/{userId} {
      // Users can read their own data; admins can read any user
      allow read: if isAuthenticated() && (isOwner(userId) || isAdminOrAbove());
      
      // Create: Allow creation if role is valid and user is creating their own doc
      allow create: if isAuthenticated() 
                    && isOwner(userId)
                    && isValidRole(request.resource.data.role);
                    
      // Update: Users can update own profile but CANNOT change role, uid, emailVerified, accountStatus
      // Admins and SuperAdmins can change anything (including role for role assignment)
      allow update: if (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid', 'emailVerified', 'accountStatus']))
                    || isAdminOrAbove();
                    
      // Delete: Admins or the user themselves (for account deletion)
      allow delete: if isAdminOrAbove() || isOwner(userId);
    }
    
    // ===================== SETTINGINFO COLLECTION ===========================
    // Platform settings — SettingInfo/platform
    match /SettingInfo/platform {
      // All authenticated users can read platform settings (for feature flags, etc.)
      allow read: if isAuthenticated();
      
      // Only admin or super admin can write platform settings
      allow write: if isAdminOrAbove();
    }

    // Organization settings — SettingInfo/organization_{orgId}
    match /SettingInfo/{settingId} {
      // Allow reading org settings if user belongs to that org, or is admin
      allow read: if isAuthenticated() && (
        isAdminOrAbove()
        || (settingId.matches('organization_.*') && getUserOrgId() != null 
            && settingId == 'organization_' + getUserOrgId())
      );
      
      // Org admins can write their own org settings; platform admins can write any
      allow write: if isAdminOrAbove()
                   || (isOrgAdmin() && settingId.matches('organization_.*') 
                       && getUserOrgId() != null 
                       && settingId == 'organization_' + getUserOrgId());
    }

    // ======================= EVENTS COLLECTION ==============================
    match /events/{eventId} {
      // Anyone can read published events
      allow read: if true; 
      
      // Create: Organizer+ role AND eventCreation feature flag must be enabled
      allow create: if isAuthenticated() 
                    && isOrganizerOrAbove()
                    && getFeatureFlag('eventCreation') == true;
      
      // Update: Event owner, or admin+
      // Update: Event owner, or admin+, or Inventory Update
      allow update: if isAuthenticated() && (
        // 1. Allow ticket inventory updates (Safe, no DB lookups)
        // This allows any auth user to update ONLY the ticket arrays (e.g. during checkout)
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ticketTypes', 'ticketTiers'])
        )
        // 2. Event Owner
        || resource.data.organizerId == request.auth.uid 
        // 3. Admin Permissions (might incur DB reads)
        || isAdminOrAbove()
        // 4. Org Admin for their org
        || (isOrgAdmin() && resource.data.organizationId == getUserOrgId())
      );
      
      // Delete: Event owner (if org permits), or admin+
      allow delete: if isAuthenticated() && (
        (resource.data.organizerId == request.auth.uid && getFeatureFlag('eventCreation') == true)
        || isAdminOrAbove()
        || (isOrgAdmin() && resource.data.organizationId == getUserOrgId())
      );
    }
    
    // ====================== BOOKINGS COLLECTION =============================
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isAdminOrAbove()
        // Organizers can read bookings for their events
        || (isOrganizerOrAbove() && resource.data.organizerId == request.auth.uid)
      );
        
      // Users can create bookings for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Allow admins to update, OR users to update their own booking (e.g. confirming payment)
      allow update: if isAdminOrAbove() || (isAuthenticated() && resource.data.userId == request.auth.uid); 
      allow delete: if false; 
    }
    
    // ======================= TICKETS COLLECTION =============================
    match /tickets/{ticketId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isAdminOrAbove() 
        || isOrganizerOrAbove()
      );
      // Users can create tickets for themselves (during booking)
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      // Users can update their own tickets (QR scan marks as used),
      // organizers can update tickets for their events
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid
        || isAdminOrAbove()
        || isOrganizerOrAbove()
      );
      allow delete: if false;
    }

    // ==================== TRANSACTIONS COLLECTION ===========================
    match /transactions/{transactionId} {
      // Users can read their own transactions; admins can read any
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid
        || isAdminOrAbove()
      );
      // Users can create transactions for themselves (on payment success)
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      // Only admins can update transactions (refund status changes)
      // Users can update their own for payment confirmation
      allow update: if isAdminOrAbove()
                    || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if false;
    }

    // ==================== PROMO CODES COLLECTION ============================
    // ==================== PROMO CODES COLLECTION ============================
    match /promo_codes/{codeId} {
      // Allow global read access for validation (e.g. valid on public checkout)
      allow read: if true;
      
      // Allow authenticated user to create (TEMPORARY FIX if role check fails)
      // Ideally should be: allow create: if isOrganizerOrAbove();
      allow create: if isAuthenticated();
      
      // Update restricts:
      // 1. Admins/Organizers can update any field (isActive, etc)
      // 2. Regular Authenticated users can ONLY increment 'usedCount'
      allow update: if isOrganizerOrAbove() 
                    || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount']));
                    
      // Only Admins/Super Admins can delete
      allow delete: if isAdminOrAbove();
    }
    
    // ======================= REVIEWS COLLECTION =============================
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdminOrAbove();
    }
    
    // ====================== ANALYTICS COLLECTION ============================
    match /analytics/{document=**} {
      allow read: if isAdminOrAbove() || isOrgAdminOrAbove();
      allow write: if false; 
    }

    // =================== AUTHORIZATION CODES ================================
    match /authorization_codes/{codeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdminOrAbove();
    }

    // ===================== NOTIFICATIONS ====================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAdminOrAbove() || isOrganizerOrAbove();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================= CART ==========================================
    match /cart/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // ======================= AUDIT LOGS =====================================
    match /audit_logs/{logId} {
      allow read: if isAdminOrAbove();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ====================== ORGANIZATIONS ===================================
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (
        isAdminOrAbove() 
        || getUserOrgId() == orgId
      );
      allow create: if isAdminOrAbove();
      allow update: if isAdminOrAbove() 
                    || (isOrgAdmin() && getUserOrgId() == orgId);
      allow delete: if isSuperAdmin();
    }
  }
}