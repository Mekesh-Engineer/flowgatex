rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Fetch role from the database
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isOrganizer() {
      return isAuthenticated() && getUserData().role == 'organizer';
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'superadmin';
    }

    // FIX 1: Update allowed roles to match your code ('user' instead of 'attendee')
    function isValidRole(role) {
      return role in ['user', 'organizer', 'admin', 'superadmin'];
    }

    // =========================================================================
    // COLLECTION RULES
    // =========================================================================
    
    // Users collection
    match /users/{userId} {
      // FIX 3: Privacy - Only allow users to read their own data (or admins)
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin() || isSuperAdmin());
      
      // Create: Allow creation if role is valid
      allow create: if isAuthenticated() 
                    && isOwner(userId)
                    && isValidRole(request.resource.data.role);
                    
      // FIX 2: Security - Prevent Privilege Escalation
      // Users can update their profile, BUT they cannot change the 'role' field
      // request.resource.data.diff(resource.data).affectedKeys() checks what fields are changing
      allow update: if (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid', 'emailVerified']))
                    || isAdmin() 
                    || isSuperAdmin();
                    
      allow delete: if isAdmin() || isSuperAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      allow read: if true; 
      allow create: if isAuthenticated() && (isOrganizer() || isAdmin() || isSuperAdmin());
      allow update: if isAuthenticated() && 
        (resource.data.organizerId == request.auth.uid || isAdmin() || isSuperAdmin());
      allow delete: if isAuthenticated() && 
        (resource.data.organizerId == request.auth.uid || isAdmin() || isSuperAdmin());
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
        
      // Ensure the booking is actually for the requesting user
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      allow update: if false; 
      allow delete: if false; 
    }
    
    // Tickets collection
    match /tickets/{ticketId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin() || isOrganizer());
      allow create: if false; 
      allow update: if false; 
      allow delete: if false;
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Analytics collection
    match /analytics/{document=**} {
      allow read: if isAdmin() || isSuperAdmin();
      allow write: if false; 
    }

    // Authorization codes collection
    match /authorization_codes/{codeId} {
      // Authenticated users can query codes to validate during registration
      allow read: if isAuthenticated();
      // Only admins / super admins can manage codes
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAdmin() || isSuperAdmin() || isOrganizer();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Carts collection â€” one document per user, keyed by userId
    match /carts/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // Audit logs collection
    match /audit_logs/{logId} {
      allow read: if isAdmin() || isSuperAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
  }
}